# File Upload Level 2
## __1. Sử dụng ứng dụng như người dùng bình thường__
Vẫn là giao diện Upload như ở Level 1 nhưng khi mình upload file `shell.php` ở như ở Level trước thì chương trình ngắt ngay lập tức.
![](1.PNG)

---
## __2. Khám phá bên sau ứng dụng__
__1. File `index.php`:__
```php
<?php
    // error_reporting(0);

    // Create folder for each user
    session_start();
    if (!isset($_SESSION['dir'])) {
        $_SESSION['dir'] = 'upload/' . session_id();
    }
    $dir = $_SESSION['dir'];
    if ( !file_exists($dir) )
        mkdir($dir);

    if(isset($_GET["debug"])) die(highlight_file(__FILE__));
    if(isset($_FILES["file"])) {
        $error = '';
        $success = '';
        try {
            $filename = $_FILES["file"]["name"];
            $extension = explode(".", $filename)[1];
            if ($extension === "php") {
                die("Hack detected");
            }
            $file = $dir . "/" . $filename;
            move_uploaded_file($_FILES["file"]["tmp_name"], $file);
            $success = 'Successfully uploaded file at: <a href="/' . $file . '">/' . $file . ' </a><br>';
            $success .= 'View all uploaded file at: <a href="/' . $dir . '">/' . $dir . ' </a>';
        } catch(Exception $e) {
            $error = $e->getMessage();
        }
    }
?>
```
Anh Developer đã fix bug Level 1 bằng cách thêm các chi tiết sau: 
* Hàm `explode(".", $filename)` sẽ cắt từng đốt trong chuỗi qua dấu `.` và trả về mảng chứa các đốt.
* Biến `$extension` nhằm lấy chuỗi đuôi file bằng cách lấy phần tử thứ 2 trong mảng ở trên.

_Xác định vị trí Untrusted Data:_
* `$_FILES`
* `$file` &rarr; `$_FILES`
* `$filename` &rarr; `$_FILES`
* `$extension` &rarr; `$filename`

__2. File `.htaccess`:__ Không thay đổi  

__3. File `docker-php.conf`:__ Không thay đổi

---
## __3. Khai thác__
Dựa vào code của anh Developer thì anh ấy đã phạm phải sai lầm. Anh ấy chỉ kiểm tra phần tử thứ 2 nhưng chuỗi đuôi file thường nằm ở cuối. Vậy giờ mình cho đuôi `php` vào phần tử thứ 3 và phần tử thứ 2 là bất kì thì sao?

Mình tận dụng con shell ở lv1 thêm `.txt` vào giữa như trong hình và upload.   
![](2.PNG)

Vậy mình thực thi thành công code PHP và tìm flag.  
>CBJS{FAKE_FLAG_FAKE_FLAG}

