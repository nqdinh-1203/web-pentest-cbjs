# SQL Injection Level 4

## __1. Sử dụng như người dùng:__
Giao diện không thay đổi và sử dụng payload ở lv trước không được.

## __2. Xem đằng sau chương trình:__
File `level4.php`:
```php
<?php
if (isset($_POST["username"]) && isset($_POST["password"])) {
    try {
        include "db.php";
        $sql = "SELECT username, password FROM users WHERE username=LOWER('" .$_POST["username"] . "')";
        $db_result = $database->query($sql);
        if ($db_result->num_rows > 0){
            $row = $db_result->fetch_assoc(); // Get the first row
            $password = $row["password"];
            if ($password === $_POST["password"]) {
                $username = $row["username"];
                if ($username === "admin") {
                    $message = "Wow you can log in as admin, so cool, but how about <a href='level5.php'>THIS LEVEL</a>!";
                }
                else
                    $message = "You log in as $username, but then what? You are not an admin";
            }
            else 
                $message = "Wrong username or password";
        }
        else {
            $message = "Username not found";
        }
    } catch(mysqli_sql_exception $e) {
        $message = $e->getMessage();
    }
}
?>
```
Ây da, lúc này anh Dev đã fix lại câu `query` bằng cách thêm `select` `password` bên cạnh `username` và anh ấy sẽ lưu `password` từ `table` vào biến `$password` rồi đem đi so sánh với `$_POST["password"]` do người dùng nhập. Nếu đúng thì sẽ so sánh `username` như các lv trước.

## __3. Lên ý tưởng và Khai thác:__
### a. <ins>Ý tưởng</ins>:
Lúc này mình đã không thể đăng nhập mà không có `password` được rồi. Với tài khoản `admin` mình lại càng không biết `password`. 

&rarr; Vậy liệu mình có thể đăng nhập tài khoản `admin` với `password` mình kiểm soát được không? 

### b. <ins>Khai thác</ins>:
Mình tận dụng `UNION` để lấy được dữ liệu trong database mà mình muốn. Mình sẽ thử test trên `db` local.  
![](1.PNG)

Với `UNION` mình sẽ gộp 2 dữ liệu của 2 bảng lại với nhau với điều kiện 2 bảng có cùng số cột. Ở ví dụ trên bảng bên trái khi mình `select` 2 cột là `username`, `password` và bảng bên phải cũng có 2 cột nên có thể gộp lại với nhau.  
Vậy nếu ở `vế trái` của `union` ta cho kiểm điều kiện ở `where` xảy ra sai thì `select` không có dòng nào mà gộp với `select` bên phải do mình kiểm soát thì lúc này `table` có thể trả ra dữ liệu của mình thôi nhỉ? Kiểm chứng:  
![](2.PNG)

&rarr; Vậy mình đã đúng và lúc này mình chỉ cần chuyển `'dinh'` &rarr; `'admin'` là mọi chuyện đã được giải quyết.

__Payload:__
```sql
khongtontai') union select 'admin', '123'-- 
```
Mình sẽ dùng Payload vào `username input` và `password input` mình nhập `123` để điều kiện kiểm tra trả ra là `true`.

![](3.PNG)  
__&rarr; Khai thác thành công__