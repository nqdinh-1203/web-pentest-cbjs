# File Upload Level 5

## __1. Sử dụng như người dùng__
![](1.PNG)
Có vẻ như lúc này app chỉ cho upload hình thôi thì phải. Mình sẽ upload 1 file php và 1 file hình xem sao.  
Mình upload file php và kêt quả:
![](2.PNG)  
Mình upload file hình và kết quả:
![](4.PNG)  
![](3.PNG)

Vậy mình chỉ upload được file hình thôi.

## __2. Khám phá bên trong ứng dụng__
__1. File `index.php`:__
```php
<?php
    // error_reporting(0);

    // Create folder for each user
    session_start();
    if (!isset($_SESSION['dir'])) {
        $_SESSION['dir'] = 'upload/' . session_id();
    }
    $dir = $_SESSION['dir'];
    if ( !file_exists($dir) )
        mkdir($dir);

    if(isset($_GET["debug"])) die(highlight_file(__FILE__));
    if(isset($_FILES["file"])) {
        $error = '';
        $success = '';
        try {
            $mime_type = $_FILES["file"]["type"];
            var_dump($mime_type);
            if (!in_array($mime_type, ["image/jpeg", "image/png", "image/gif"])) {
                die("Hack detected");
            }
            $file = $dir . "/" . $_FILES["file"]["name"];
            move_uploaded_file($_FILES["file"]["tmp_name"], $file);
            $success = 'Successfully uploaded file at: <a href="/' . $file . '">/' . $file . ' </a><br>';
            $success .= 'View all uploaded file at: <a href="/' . $dir . '">/' . $dir . ' </a>';
        } catch(Exception $e) {
            $error = $e->getMessage();
        }
    }
?>
```
Lúc này anh Dev đã không lấy biến `name` nữa mà chuyển sang `type` đặt tên cho biến là `$mime_type`. Nếu `$mime_type` khác 1 trong các `type` như _image/jpeg_, _image/png_, _image/gif_ thì sẽ bị coi như là hack.  
Và những dòng code còn lại đều như cũ.

__2. File `.htaccess`:__ Không thay đổi  

__3. File `docker-php.conf`:__ Không thay đổi

## __3. Khai thác__
Vì phần code chỉ kiểm tra phần `type` vậy mình sẽ tận dụng Burp Suite để chỉnh lại phần `Content-Type` là `image/jpeg` và gửi lên Server.  
![](5.PNG)  
Kết quả đã gửi lên thành công

Xem trong thư mục người dùng có file php vừa up  
![](6.PNG)

Mình RCE Server thôi

___Flag:___
>CBJS{FAKE_FLAG_FAKE_FLAG}