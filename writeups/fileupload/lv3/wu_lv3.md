# File Upload Level 3

## __1. Sử dụng như người dùng__
Vẫn là giao diện Upload như ở Level 1 và Level 2 nhưng khi mình upload file `shell.php` và `shell.txt.php` ở như ở Level trước thì chương trình ngắt ngay lập tức.
![](1.PNG)

## __2. Khám phá bên sau ứng dụng__
__1. File `index.php`:__
```php
<?php
    // error_reporting(0);

    // Create folder for each user
    session_start();

    // nếu không đc set dir thì session dir = upload/session id 
    if (!isset($_SESSION['dir'])) {
        $_SESSION['dir'] = 'upload/' . session_id();
    }


    $dir = $_SESSION['dir'];
    if ( !file_exists($dir) )
        mkdir($dir);

    if(isset($_GET["debug"])) 
        die(highlight_file(__FILE__));
    if(isset($_FILES["file"])) {
        $error = '';
        $success = '';
        try {
            $filename = $_FILES["file"]["name"];
            // extension = đốt cuối của file name
            $extension = end(explode(".", $filename));
            
            // Nếu extension là php thì cút
            if ($extension === "php") {
                die("Hack detected");
            }
            $file = $dir . "/" . $filename;
            move_uploaded_file($_FILES["file"]["tmp_name"], $file);
            $success = 'Successfully uploaded file at: <a href="/' . $file . '">/' . $file . ' </a><br>';
            $success .= 'View all uploaded file at: <a href="/' . $dir . '">/' . $dir . ' </a>';
        } catch(Exception $e) {
            $error = $e->getMessage();
        }
    }
?>
```
À vậy cuối cùng anh dev đã fix bug Level 2 bằng cách dùng hàm `end()` để lấy phần tử cuối cùng của mảng các phần tử tách bởi `$filename` bằng với `"php"` thì cho ra đảo ngay lập tức.  
Còn lại thì không có gì thay đổi

_Vị trí Untrusted Data:_
* `$_FILES`
* `$filename` &rarr; `$_FILES`
* `$extension` &rarr; `$filename`

__2. File `.htaccess`:__ Không thay đổi  

__3. File `docker-php.conf`:__ Không thay đổi

## __3. Khai thác__
Mình vẫn sẽ đánh vào Untrusted Data. Vì anh Dev dùng `$extension` cho luồng xử lý kiểm tra nên mình sẽ đánh vào biến này.  
Với cách kiểm tra `$extension === "php"` vậy mình còn đuôi file nào khác mà chạy được file PHP không nhỉ? Mình sẽ đi search google  
___Kết quả:___  
![](2.PNG)

Vậy mình có đuôi file khác là _phtml_ vậy mình tiến hành thôi.  
Bây giờ chuyển qua dùng Burp Suite  
![](3.PNG)
À vậy mình đã upload thành công với `shell.phtml`

Bây giờ mình làm như ở các Level khác để lấy flag thôi.

___Flag:___
>CBJS{FAKE_FLAG_FAKE_FLAG}